name: Deploy to VM

on:
  push:
    branches: [ main ]   # or 'master' if that's your default

jobs:
  deploy:
    # This tells GitHub: run this job on your VM (self-hosted runner)
    runs-on: [self-hosted, Windows]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restart City Services API
        shell: powershell

        run: |
          $ErrorActionPreference = "Stop"

          # Stop any existing python app for a clean restart (simple dev approach)
          Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue

          # Start the app from the runner's workspace
          $workdir = "${{ github.workspace }}"
          Write-Host "Starting app in $workdir"
          Start-Process python "api.py" -WorkingDirectory $workdir -WindowStyle Hidden
